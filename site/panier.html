<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="utf-8">
    <title>kedufron't - Panier</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://kit.fontawesome.com/4495018b32.js" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lilita+One&family=Protest+Riot&display=swap">
</head>
<body>
    <header>
        <div class="banner">
            <div class="banner">
                <ul class="banner_utility_items">
                    <!-- éléments du menu... -->
                </ul>
            </div>
        </div>
    </header>
    <main>
        <h2 class="paniertitre">Votre Panier :</h2>
        <div class="panier">
            <div id="cart-details">
                <!-- Les articles du panier seront affichés ici -->
            </div>
            <div class="infopaye">
                <h2>Total</h2>
                <div class="soustot">
                    <p id="subTotal">sous-total</p>
                </div>
                <button id="proceedToCheckoutButton">Procéder au paiement</button>
                <button id="clearCartButton">Effacer le panier</button> <!-- Bouton pour effacer le panier -->
            </div>
        </div>
    </main>
    <footer>
        <ul class="basdepage">
            <!-- éléments du pied de page... -->
        </ul>
    </footer>

    <script>
        // Récupérer les articles du panier depuis le stockage local
        var articlesDansPanier = JSON.parse(localStorage.getItem('panier')) || [];

        // Fonction pour afficher les articles dans le panier
        function displayCartItems() {
            var cartDetailsDiv = document.getElementById('cart-details');
            if (articlesDansPanier.length > 0) {
                // Générer le HTML pour afficher les articles et leurs quantités
                var fetchPromises = articlesDansPanier.map(function(article) {
                    // Vérifier si la quantité est supérieure à zéro
                    if (article.quantity > 0) {
                        return fetch(`https://api.kedufront.juniortaker.com/item/${article.productId}`)
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error('Erreur lors de la récupération des données');
                                }
                                return response.json();
                            })
                            .then(data => {
                                var product = data.item;
                                var total = product.price * article.quantity; // Calculer le total pour cet article
                                // Afficher les détails du produit dans le panier
                                return `<div class="cart-item">
                                            <img src="https://api.kedufront.juniortaker.com/item/picture/${article.productId}" alt="${product.name}">
                                            <p>Nom du produit: ${product.name}</p>
                                            <p>Prix du produit: ${product.price} €</p>
                                            <p>Quantité: 
                                                <select onchange="updateQuantity('${article.productId}', this.value)">
                                                    ${generateQuantityOptions(article.quantity)}
                                                </select>
                                            </p>
                                            <p>Total: ${total} €</p>
                                        </div>`;
                            })
                            .catch(error => {
                                console.error('Erreur:', error);
                            });
                    }
                });

                Promise.all(fetchPromises).then(function(cartItemsHTMLArray) {
                    // Filtrer les articles vides (avec une quantité de zéro)
                    cartItemsHTMLArray = cartItemsHTMLArray.filter(function(item) {
                        return item !== undefined;
                    });
                    // Mettre à jour le contenu du div cart-details avec les articles du panier
                    if (cartItemsHTMLArray.length > 0) {
                        cartDetailsDiv.innerHTML = cartItemsHTMLArray.join('');
                    } else {
                        cartDetailsDiv.innerHTML = `<p>Aucun article dans le panier</p>`;
                    }

                    // Calculer le sous-total comme la somme des totaux de tous les articles
                    var subTotal = articlesDansPanier.reduce(function(acc, curr) {
                        return acc + (curr.quantity * curr.product.price); // Utiliser les détails du produit stockés dans l'objet article
                    }, 0);

                    // Mettre à jour la div "soustot" avec le sous-total calculé
                    var sousTotalDiv = document.getElementById('subTotal');
                    sousTotalDiv.textContent = "Sous-total: " + subTotal + " €";
                });
            } else {
                cartDetailsDiv.innerHTML = `<p>Le panier est vide</p>`;
            }
        }

        // Fonction pour générer les options de quantité
        function generateQuantityOptions(selectedQuantity) {
            var options = '';
            for (var i = 1; i <= 10; i++) {
                options += `<option value="${i}" ${selectedQuantity == i ? 'selected' : ''}>${i}</option>`;
            }
            return options;
        }

        // Fonction pour mettre à jour la quantité d'un article dans le panier
        function updateQuantity(productId, newQuantity) {
            var index = articlesDansPanier.findIndex(item => item.productId === productId);
            if (index !== -1) {
                articlesDansPanier[index].quantity = parseInt(newQuantity);
                // Mettre à jour le panier dans le stockage local
                localStorage.setItem('panier', JSON.stringify(articlesDansPanier));
                // Mettre à jour l'affichage du panier
                displayCartItems();
            }
        }

        // Fonction pour effacer le panier
        document.getElementById('clearCartButton').addEventListener('click', function() {
            localStorage.removeItem('panier');
            location.reload();
        });

        // Afficher les articles du panier au chargement de la page
        displayCartItems();
    </script>
</body>
</html>
